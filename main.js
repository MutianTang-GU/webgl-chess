(()=>{"use strict";async function e(e){let t=await fetch(e);return await t.text()}async function t(e){let t=await fetch(e);return await t.json()}async function r(e,t,r){return function(e,t,r){const i=e.createShader(e.VERTEX_SHADER);if(e.shaderSource(i,t),e.compileShader(i),!e.getShaderParameter(i,e.COMPILE_STATUS))throw new Error("An error occurred compiling the shaders"+e.getShaderInfoLog(i));const a=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(a,r),e.compileShader(a),!e.getShaderParameter(a,e.COMPILE_STATUS))throw new Error("An error occurred compiling the shaders"+e.getShaderInfoLog(a));const o=e.createProgram();if(e.attachShader(o,i),e.attachShader(o,a),e.linkProgram(o),!e.getProgramParameter(o,e.LINK_STATUS))throw new Error("Unable to initialize the shader program: "+e.getProgramInfoLog(o));return o}(e,await t,await r)}function i(e,t,r,i,a,o,n,s,c){e.useProgram(t);const d={},h={};return h.vertexBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,h.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW),d.positionAttributeLocation=e.getAttribLocation(t,n),i&&(h.normalBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,h.normalBuffer),e.bufferData(e.ARRAY_BUFFER,i,e.STATIC_DRAW),d.normalAttributeLocation=e.getAttribLocation(t,s)),a&&(h.textureCoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,h.textureCoordBuffer),e.bufferData(e.ARRAY_BUFFER,a,e.STATIC_DRAW),d.textureCoordAttributeLocation=e.getAttribLocation(t,c)),o&&(h.indexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,h.indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,o,e.STATIC_DRAW)),()=>{e.enableVertexAttribArray(d.positionAttributeLocation),e.bindBuffer(e.ARRAY_BUFFER,h.vertexBuffer);{const t=3,r=e.FLOAT,i=!1,a=0,o=0;e.vertexAttribPointer(d.positionAttributeLocation,t,r,i,a,o)}if(i){e.enableVertexAttribArray(d.normalAttributeLocation),e.bindBuffer(e.ARRAY_BUFFER,h.normalBuffer);{const t=3,r=e.FLOAT,i=!1,a=0,o=0;e.vertexAttribPointer(d.normalAttributeLocation,t,r,i,a,o)}}if(a){e.enableVertexAttribArray(d.textureCoordAttributeLocation),e.bindBuffer(e.ARRAY_BUFFER,h.textureCoordBuffer);{const t=2,r=e.FLOAT,i=!1,a=0,o=0;e.vertexAttribPointer(d.textureCoordAttributeLocation,t,r,i,a,o)}}}}function a(e,t,r,i){const a=e.getUniformLocation(t,r);e.uniformMatrix4fv(a,!1,i)}function o(e,t,r,i){const a=e.getUniformLocation(t,r);e.uniform3fv(a,i)}class n{constructor(){this.positions=[[4,1,1,!0],[1,2,1,!0],[2,2,1,!0],[3,2,1,!0],[4,2,1,!0],[5,2,1,!0],[6,2,1,!0],[2,1,1,!0],[1,1,1,!0],[7,2,1,!0],[3,1,1,!0],[5,1,1,!0],[8,1,1,!0],[7,1,1,!0],[6,1,1,!0],[8,2,1,!0],[4,8,1,!1],[1,7,1,!1],[2,7,1,!1],[3,7,1,!1],[4,7,1,!1],[5,7,1,!1],[6,7,1,!1],[2,8,1,!1],[1,8,1,!1],[7,7,1,!1],[3,8,1,!1],[5,8,1,!1],[8,8,1,!1],[7,8,1,!1],[6,8,1,!1],[8,7,1,!1]],this.animateInProgress=!1}getPieceIndex(e,t){return this.positions.findIndex((r=>r[0]===e&&r[1]===t&&1===r[2]))}movePieceAnimate(e,t,r,i){if(this.animateInProgress)return;const a=this.positions[this.getPieceIndex(e,t)],o=this.positions[this.getPieceIndex(r,i)];return this.animateInProgress=!0,n=>{a[0]=e+(r-e)*n,a[1]=t+(i-t)*n,o&&(o[2]=1-n),1===n&&(this.animateInProgress=!1)}}}var s=1e-6,c="undefined"!=typeof Float32Array?Float32Array:Array;function d(){var e=new c(16);return c!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function h(e,t,r){var i,a,o,n,s,c,d,h,l,u,m,f,g=r[0],A=r[1],E=r[2];return t===e?(e[12]=t[0]*g+t[4]*A+t[8]*E+t[12],e[13]=t[1]*g+t[5]*A+t[9]*E+t[13],e[14]=t[2]*g+t[6]*A+t[10]*E+t[14],e[15]=t[3]*g+t[7]*A+t[11]*E+t[15]):(i=t[0],a=t[1],o=t[2],n=t[3],s=t[4],c=t[5],d=t[6],h=t[7],l=t[8],u=t[9],m=t[10],f=t[11],e[0]=i,e[1]=a,e[2]=o,e[3]=n,e[4]=s,e[5]=c,e[6]=d,e[7]=h,e[8]=l,e[9]=u,e[10]=m,e[11]=f,e[12]=i*g+s*A+l*E+t[12],e[13]=a*g+c*A+u*E+t[13],e[14]=o*g+d*A+m*E+t[14],e[15]=n*g+h*A+f*E+t[15]),e}function l(e,t,r){var i=r[0],a=r[1],o=r[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*a,e[5]=t[5]*a,e[6]=t[6]*a,e[7]=t[7]*a,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});class u{constructor(){this.checkerboard=new n,this.cameraAngles=[0,Math.PI/4],this.atTopView=!1,this.gridSelected=null}position(e,t){return[8.3-.95*e,8.45-.95*t,.01]}preFetchResources(){this.resources={chessObjPromise:t("./assets/objects/chess-pieces.json"),pieceVertexShaderPromise:e("./assets/shaders/piece-vert.glsl"),pieceFragmentShaderPromise:e("./assets/shaders/piece-frag.glsl"),boardVertexShaderPromise:e("./assets/shaders/board-vert.glsl"),boardFragmentShaderPromise:e("./assets/shaders/board-frag.glsl")}}init(){const e=document.getElementById("gl-canvas").getContext("webgl2");if(null===e)return void alert("Unable to initialize WebGL. Your browser or machine may not support it.");e.clearColor(1,1,1,1);const t=r(e,this.resources.pieceVertexShaderPromise,this.resources.pieceFragmentShaderPromise),i=r(e,this.resources.boardVertexShaderPromise,this.resources.boardFragmentShaderPromise);this.gl=e,this.program={pieceShaderProgramPromise:t,boardShaderProgramPromise:i};const a=new Image,o=new Promise((e=>{a.addEventListener("load",(()=>e(a)))}));a.src="./assets/textures/board.jpg",this.textureImagePromise=o}fetchResources(){return Promise.all([this.resources.chessObjPromise,this.program.pieceShaderProgramPromise,this.program.boardShaderProgramPromise,this.textureImagePromise])}createObjects(e){const t=this.gl,[r,a,n,s]=e;t.useProgram(n);const c=t.createTexture();t.bindTexture(t.TEXTURE_2D,c);{const e=0,r=t.RGBA,i=t.RGBA,a=t.UNSIGNED_BYTE;t.texImage2D(t.TEXTURE_2D,e,r,i,a,s)}t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.generateMipmap(t.TEXTURE_2D);const d=i(t,n,new Float32Array([0,0,0,0,8,0,8,8,0,8,0,0]),null,new Float32Array([0,0,0,1,1,1,1,0]),new Uint16Array([0,1,2,0,2,3]),"vertPosition",null,"texCoord");t.useProgram(a);const h=r.meshes,l=h.map((e=>e.vertices)).flat(),u=h.map((e=>e.vertices.slice(0,3).map((e=>-e)))),m=h.map((e=>e.normals)).flat(),f=[];let g=0,A=0;const E=h.map((e=>{const t=e.faces.flat().map((e=>e+g));return g+=e.vertices.length/3,A+=3*e.faces.length,f.push(A),t})).flat(),P=i(t,a,new Float32Array(l),new Float32Array(m),null,new Uint16Array(E),"vertPosition","vertNormal",null);o(t,a,"lightPosition",[-10,10,10]),this.programInfo={pieceShaderProgram:a,boardShaderProgram:n,bindBoard:d,bindPiece:P,pieceOffsets:f,pieceOrigins:u,setPieceWhite:()=>{o(t,a,"ambientLightColor",[.5,.5,.5]),o(t,a,"diffuseLightColor",[.8,.8,.8]),o(t,a,"specularLightColor",[1,1,1])},setPieceBlack:()=>{o(t,a,"ambientLightColor",[.2,.2,.2]),o(t,a,"diffuseLightColor",[.3,.3,.3]),o(t,a,"specularLightColor",[1,1,1])}}}resetCamera(){const[e,t]=this.cameraAngles,r=Math.PI/2-.01;let i,a=0,o=null;const n=new Promise((e=>i=e)),s=n=>{if(a>=1)return this.cameraAngles=[0,r],this.draw(),void i();null===o&&(o=n);const c=n-o;o=n,a+=5e-4*c,this.cameraAngles=[e+(0-e)*a,t+(r-t)*a],this.draw(),requestAnimationFrame(s)};return requestAnimationFrame(s),n}movePieceAnimate(e,t,r,i){const a=this.checkerboard.movePieceAnimate(e,t,r,i);let o=0,n=null;const s=e=>{if(o>=1)return a(1),void this.draw();null===n&&(n=e);const t=e-n;n=e,o+=5e-4*t,a(o),this.draw(),requestAnimationFrame(s)};requestAnimationFrame(s)}mouseClicked(e,t){const r=Math.floor((e-120)/50),i=Math.floor((t-20)/50);if(r<0||r>7||i<0||i>7)return;const a=r+1,o=8-i;this.boardClicked(a,o)}boardClicked(e,t){if(null===this.gridSelected){if(-1===this.checkerboard.getPieceIndex(e,t))return;return this.gridSelected=[e,t],void this.draw()}if(this.gridSelected[0]===e&&this.gridSelected[1]===t)return this.gridSelected=null,void this.draw();this.movePieceAnimate(this.gridSelected[0],this.gridSelected[1],e,t),this.gridSelected=null}addControllers(){const e=document.getElementById("vertical-controller"),t=document.getElementById("horizontal-controller"),r=document.getElementById("chess-control"),i=document.getElementById("gl-canvas");r.addEventListener("click",(r=>{this.resetCamera().then((()=>{i.classList.remove("forbidden"),this.atTopView=!0})),e.value=89,t.value=0})),e.addEventListener("input",(e=>{i.classList.add("forbidden"),this.atTopView=!1,this.cameraAngles[1]=e.target.value/180*Math.PI,this.draw()})),t.addEventListener("input",(e=>{i.classList.add("forbidden"),this.atTopView=!1,this.cameraAngles[0]=e.target.value/180*Math.PI,this.draw()}));const a=i.getBoundingClientRect();i.addEventListener("click",(e=>{if(!this.atTopView)return;const t=e.clientX-a.left,r=e.clientY-a.top;this.mouseClicked(t,r)}))}draw(){const e=this.gl,{pieceShaderProgram:t,boardShaderProgram:r,bindBoard:i,bindPiece:o,pieceOffsets:n,pieceOrigins:c,setPieceWhite:u,setPieceBlack:m}=this.programInfo;e.clearDepth(1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const f=d();!function(e,t,r,i,a){var o,n=1/Math.tan(t/2);e[0]=n/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=a&&a!==1/0?(o=1/(i-a),e[10]=(a+i)*o,e[14]=2*a*i*o):(e[10]=-1,e[14]=-2*i)}(f,45*Math.PI/180,e.canvas.clientWidth/e.canvas.clientHeight,.1,50);const[g,A]=this.cameraAngles,E=d();var P,R,b,p,T,S,L,v,w,I,B,F,x,_,M,U,C,y,D,N,O,k,Y;P=E,M=(R=[4+10*Math.sin(g)*Math.cos(A),4+10*Math.cos(g)*Math.cos(A),1+10*Math.sin(A)])[0],U=R[1],C=R[2],y=(p=[0,0,1])[0],D=p[1],N=p[2],O=(b=[4,4,0])[0],k=b[1],Y=b[2],Math.abs(M-O)<s&&Math.abs(U-k)<s&&Math.abs(C-Y)<s?function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(P):(B=M-O,F=U-k,x=C-Y,T=D*(x*=_=1/Math.hypot(B,F,x))-N*(F*=_),S=N*(B*=_)-y*x,L=y*F-D*B,(_=Math.hypot(T,S,L))?(T*=_=1/_,S*=_,L*=_):(T=0,S=0,L=0),v=F*L-x*S,w=x*T-B*L,I=B*S-F*T,(_=Math.hypot(v,w,I))?(v*=_=1/_,w*=_,I*=_):(v=0,w=0,I=0),P[0]=T,P[1]=v,P[2]=B,P[3]=0,P[4]=S,P[5]=w,P[6]=F,P[7]=0,P[8]=L,P[9]=I,P[10]=x,P[11]=0,P[12]=-(T*M+S*U+L*C),P[13]=-(v*M+w*U+I*C),P[14]=-(B*M+F*U+x*C),P[15]=1),function(e,t,r){var i=t[0],a=t[1],o=t[2],n=t[3],s=t[4],c=t[5],d=t[6],h=t[7],l=t[8],u=t[9],m=t[10],f=t[11],g=t[12],A=t[13],E=t[14],P=t[15],R=r[0],b=r[1],p=r[2],T=r[3];e[0]=R*i+b*s+p*l+T*g,e[1]=R*a+b*c+p*u+T*A,e[2]=R*o+b*d+p*m+T*E,e[3]=R*n+b*h+p*f+T*P,R=r[4],b=r[5],p=r[6],T=r[7],e[4]=R*i+b*s+p*l+T*g,e[5]=R*a+b*c+p*u+T*A,e[6]=R*o+b*d+p*m+T*E,e[7]=R*n+b*h+p*f+T*P,R=r[8],b=r[9],p=r[10],T=r[11],e[8]=R*i+b*s+p*l+T*g,e[9]=R*a+b*c+p*u+T*A,e[10]=R*o+b*d+p*m+T*E,e[11]=R*n+b*h+p*f+T*P,R=r[12],b=r[13],p=r[14],T=r[15],e[12]=R*i+b*s+p*l+T*g,e[13]=R*a+b*c+p*u+T*A,e[14]=R*o+b*d+p*m+T*E,e[15]=R*n+b*h+p*f+T*P}(f,f,E),e.useProgram(r),a(e,r,"projMatrix",f),i(),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0),e.useProgram(t),a(e,t,"projMatrix",f);const V=e=>[3.5*e,3.5*e,3.5*e];o(),u();for(let r=0;r<16;r++){const[i,o,s]=this.checkerboard.positions[r];if(0===s)continue;const u=d();h(u,u,this.position(i,o)),l(u,u,V(s)),h(u,u,c[r]),a(e,t,"viewMatrix",u);const m=n[r-1]||0,f=n[r]-m;e.drawElements(e.TRIANGLES,f,e.UNSIGNED_SHORT,2*m)}m();for(let r=0;r<16;r++){const[i,o,s]=this.checkerboard.positions[r+16];if(0===s)continue;const u=d();h(u,u,this.position(i,o)),l(u,u,V(s)),h(u,u,c[r]),a(e,t,"viewMatrix",u);const m=n[r-1]||0,f=n[r]-m;e.drawElements(e.TRIANGLES,f,e.UNSIGNED_SHORT,2*m)}}clearLoadingText(){document.getElementById("loading-text").remove()}}async function m(){if("file:"===window.location.protocol){const e="This example requires a web server to load the model. Please run this example from a web server.";throw alert(e),new Error(e)}const e=new u;e.preFetchResources(),e.init();const t=await e.fetchResources();e.createObjects(t),e.draw(),e.addControllers(),e.clearLoadingText()}"loading"!==document.readyState?m():document.addEventListener("DOMContentLoaded",m)})();